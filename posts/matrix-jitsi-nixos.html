<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Declarative, Decentralised, and Secure communication via Matrix, Jitsi, & NixOS</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/custom.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/fa.min.css" />
        <link rel="stylesheet" href="https://use.typekit.net/jrr7jdg.css">
    </head>
    <body>
        <header>
            <div class="page-width">
                <a href="../">
                    <div class="site-logo">
                        kaushikc.Org
                    </div>
                </a>
                <nav>
                    <div class="menu-main-menu-container">
                        <input type="checkbox" id="menu-main-menu-toggle" class="menu-toggle">
                        <label for="menu-main-menu-toggle" class="label-toggle main-menu" data-open="Main Menu" data-close="Close Menu"></label>
                        <ul class="menu" role="menubar">
                            <li class="menu-item">
                                <a title="Archive" href="../archive.html"><i class="fas fa-archive"></i> Archive</a>
                            </li>
                            <li class="menu-item">
                                <a href="../resume.html"><i class="fas fa-lightbulb"></i> CV</a>
                            </li>
                            <li class="menu-item">
                                <a title="Micro Blog" href="http://micro.kaushikc.org"><i class="fab fa-microblog"></i> Micro</a>
                            </li>
                            <li class="menu-item">
                                <a target="_blank" title="Keybase Profile" href="https://keybase.io/kaushikc"><i class="fab fa-keybase"></i></a>
                            </li>
                            <li class="menu-item">
                                <a id="chat-icon" target="_blank" title="Keybase Chat" href="https://keybase.io/kaushikc/chat""><i class="fas fa-comments"></i></a>
                            </li>
                            <li class="menu-item">
                                <a title="RSS" href="../atom.xml"><i class="fas fa-rss"></i></a>
                            </li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>

        <main role="main" class="page-width">
            <article class="post">
    <h1>
        
        <a href="../posts/matrix-jitsi-nixos.html">
            Declarative, Decentralised, and Secure communication via Matrix, Jitsi, & NixOS
        </a>
        
        <a href="../posts/matrix-jitsi-nixos.html" class="link-perma">
            <span>●</span>
        </a>
    </h1>
    <div class="byline">
    <p class="date">April 10, 2020</p>
    <p class="author"><a title="All pages tagged 'technology'." href="../tags/technology.html">technology</a>, <a title="All pages tagged 'nixos'." href="../tags/nixos.html">nixos</a></p>
</div>
<div class="bodycopy">
    <p>It has been one of my strong pursuit to figure out a properly encrypted and decentralised communication setup. <a href="matrix.org">Matrix</a>’s claim to provide that is pretty strong against other alternatives. I’ve been using <a href="riot.im">Riot</a>, the most feature rich Matrix client, but mainly as an IRC bouncer.</p>
<p>Just the other day I read this awesome guide on <em><a href="https://matrix.org/blog/2020/04/06/running-your-own-secure-communication-service-with-matrix-and-jitsi">Running your own secure communication service with Matrix and Jitsi</a></em> and realised it’s not that difficult nowadays to setup all the pieces of the puzzle.</p>
<p>And so if I want to follow those steps shown in the above article but rather do it in NixOS - another project I am really excited about - how easy/difficult it would be ?</p>
<p>Well apart from minor tweaks, it was pretty straightforward and I would argue more simpler than how its done for a Debian based system. Following is the rundown of how I made the relevant steps work for my setup. I am not going to repeat all the nice technical explanations of above article. So anyone following <strong>should </strong>first read the above article.</p>
<p>Before we begin, I would also like to address one difference from the basic premise of the above article - Unlike in the above article the main domain (<em>dangerousdemos.net</em>) is already pointing to an existing blog <a href="https://help.github.com/en/github/working-with-github-pages/configuring-a-custom-domain-for-your-github-pages-site">hosted from a Github repository</a>. I think this might be a case for many like me who already have a domain name serving a static blog (like this one) but want to setup Matrix via the subdomains.</p>
<p>So lets begin,</p>
<h2 id="nixos">NixOS</h2>
<p>With NixOS every step is declarative and hence we don’t have to worry about the mechanical rigor as is the case with most of the steps in the original article. What it entails for us broadly are these 3 steps (<em>apart from some additional stuff</em>)</p>
<ul>
<li>Update <code>/etc/nixos/configuration.nix</code></li>
<li>Run <code>sudo nixos-rebuild switch</code></li>
<li>Done!</li>
</ul>
<p><a href="https://nixos.org/">NixOS</a> made following the original article really easy as I could make mistakes and not worry because I could rollback and start again. Let that sink in as I think that in itself is mind-blowing.</p>
<h2 id="dns">DNS</h2>
<p>Let’s use the same domain name - <em>dangerousdemos.net</em> - as used in the original article for our explanations. As mentioned above, we have one change here that the root domain already is redirecting to the static blog hosted in Github Pages. So we need to setup <code>A</code> records for the following subdomains:</p>
<ul>
<li><code>matrix.dangerousdemos.net</code> (for Synapse)</li>
<li><code>riot.dangerousdemos.net</code> (for Riot/Web)</li>
<li><code>jitsi.dangerousdemos.net</code> (for Jitsi)</li>
<li><em><code>turn.dangerousdemos.net</code></em> (for coturn based <code>TURN</code> server that in original article is taken care by <code>jitsi-meet</code> installer)</li>
</ul>
<p><em>Its important for all these to setup in the DNS before we run our configurations so that LetsEncrypt challenge flow works fine or else we might face errors.</em></p>
<h2 id="firewall">Firewall</h2>
<p>We need to ensure that following ports are open in the NixOS firewall for all the configurations to work fine</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">networking.firewall</span> = {</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">allowedUDPPorts</span> = [ 5349 5350]<span class="kw">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">allowedTCPPorts</span> = [ 80 443 3478 3479]<span class="kw">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span></code></pre></div>
<h2 id="nginx-with-letsencrypt">Nginx with LetsEncrypt</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">services.nginx</span> = {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>   <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>   <span class="ex">virtualHosts</span> = {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">## virtual host for Syapse</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;matrix.dangerousdemos.net&quot;</span> = {</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>       <span class="co">## for force redirecting HTTP to HTTPS</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>       <span class="ex">forceSSL</span> = true<span class="kw">;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>       <span class="co">## this setting takes care of all LetsEncrypt business</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>       <span class="ex">enableACME</span> = true<span class="kw">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>       <span class="ex">locations.</span><span class="st">&quot;/&quot;</span> = {</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>         <span class="ex">proxyPass</span> = <span class="st">&quot;http://localhost:8008&quot;</span><span class="kw">;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>       <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>     <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>     <span class="co">## virtual host for Riot/Web</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>     <span class="st">&quot;riot.dangerousdemos.net&quot;</span> = {</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>       <span class="co">## for force redirecting HTTP to HTTPS</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>       <span class="ex">forceSSL</span> = true<span class="kw">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>       <span class="co">## this setting takes care of all LetsEncrypt business</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>       <span class="ex">enableACME</span> = true<span class="kw">;</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>       <span class="co">## root points to the riot-web package content, also configured via Nix</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>       <span class="ex">locations.</span><span class="st">&quot;/&quot;</span> = {</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>           <span class="ex">root</span> = pkgs.riot-web<span class="kw">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>       <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>     <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>     <span class="co">## virtual host for Jitsi, reusing the same hostname as used</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>     <span class="co">## while configuring jitsi-meet</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>     <span class="va">${config</span><span class="er">.services.jitsi-meet.hostName</span><span class="va">}</span> = {</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>       <span class="ex">enableACME</span> = true<span class="kw">;</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>       <span class="ex">forceSSL</span> = true<span class="kw">;</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>     <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>   <span class="er">}</span><span class="kw">;</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>   <span class="co">## other nginx specific best practices</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>   <span class="ex">recommendedGzipSettings</span> = true<span class="kw">;</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>   <span class="ex">recommendedOptimisation</span> = true<span class="kw">;</span></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>   <span class="ex">recommendedTlsSettings</span> = true<span class="kw">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a> <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>The above setups Nginx along with LetsEncrypt. If it’s required (like in the original article) to setup main domain as a virtual host then make an additional entry inside <code>virtualHosts</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;dangerousdemos.net&quot;</span> = {</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">forceSSL</span> = true<span class="kw">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">enableACME</span> = true<span class="kw">;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="ex">locations.</span><span class="st">&quot;/&quot;</span> = {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">root</span> = <span class="st">&quot;/var/www/dangerousdemos.net&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<h2 id="synapse">Synapse</h2>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">services.matrix-synapse</span> = {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">## domain for the Matrix IDs</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">server_name</span> = <span class="st">&quot;dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">## enable metrics collection</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">enable_metrics</span> = true<span class="kw">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">## enable user registration</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">enable_registration</span> = true<span class="kw">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">## Synapse guys recommend to use PostgreSQL over SQLite</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="ex">database_type</span> = <span class="st">&quot;psycopg2&quot;</span><span class="kw">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">## database setup clarified later</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="ex">database_args</span> = {</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      <span class="ex">password</span> = <span class="st">&quot;synapse&quot;</span><span class="kw">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="kw">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">## default http listener which nginx will passthrough to</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    <span class="ex">listeners</span> = [</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      <span class="kw">{</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        <span class="ex">port</span> = 8008<span class="kw">;</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        <span class="ex">tls</span> = false<span class="kw">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="ex">resources</span> = [</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>          <span class="kw">{</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>            <span class="ex">compress</span> = true<span class="kw">;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>            <span class="ex">names</span> = [<span class="st">&quot;client&quot;</span> <span class="st">&quot;webclient&quot;</span> <span class="st">&quot;federation&quot;</span>]<span class="kw">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>          <span class="kw">}</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="ex">]</span><span class="kw">;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">}</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="ex">]</span><span class="kw">;</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">## coturn based TURN server integration (TURN server setup mentioned later),</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">## shared secret generated while configuring coturn</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">## and reused here (power of Nix being a real programming language)</span></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>    <span class="ex">turn_uris</span> = [</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;turn:turn.dangerousdemos.net:3478?transport=udp&quot;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;turn:turn.dangerousdemos.net:3478?transport=tcp&quot;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>    <span class="ex">]</span><span class="kw">;</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="ex">turn_shared_secret</span> = config.services.coturn.static-auth-secret<span class="kw">;</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>Unlike in the original article we will do <a href="https://github.com/matrix-org/synapse#using-postgresql">what’s recommended by Synapse team</a> and configure PostgreSQL. In the current NixOS configuration for <code>services.matrix-synapse</code> it might be configuring PostgreSQL automatically based on the <code>database_type</code> setting but that will change in the new versions of NixOS where PostgreSQL setups need to happen separately. Here’s how we will do it for Synapse</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">services.postgresql</span> = {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">## postgresql user and db name remains in the</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## service.matrix-synapse.database_args setting which</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">## by default is matrix-synapse</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">initialScript</span> = pkgs.writeText <span class="st">&quot;synapse-init.sql&quot;</span> <span class="st">''</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CREATE</span> ROLE <span class="st">&quot;matrix-synapse&quot;</span> WITH LOGIN PASSWORD <span class="st">'synapse'</span><span class="kw">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>        <span class="ex">CREATE</span> DATABASE <span class="st">&quot;matrix-synapse&quot;</span> WITH OWNER <span class="st">&quot;matrix-synapse&quot;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>            <span class="ex">TEMPLATE</span> template0</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>            <span class="ex">LC_COLLATE</span> = <span class="st">&quot;C&quot;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>            <span class="ex">LC_CTYPE</span> = <span class="st">&quot;C&quot;</span><span class="kw">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">''</span><span class="kw">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p><strong>Federation setting</strong></p>
<p>Original article’s description for <a href="https://matrix.org/blog/2020/04/06/running-your-own-secure-communication-service-with-matrix-and-jitsi#synapse">how to configure so that Matrix could find one’s server is nice</a>. I am just leveraging that with one additional setting required when there is already a static blog running via Github Pages pointing to base domain:</p>
<ul>
<li><p>create a file having this path <code>.well-known/matrix/server</code> in the top level of the Github repository serving the static site having the following content</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="dt">&quot;m.server&quot;</span><span class="fu">:</span> <span class="st">&quot;matrix.dangerousdemos.net:443&quot;</span> <span class="fu">}</span></span></code></pre></div></li>
<li><p>Github Pages via Jekyll exclude dotfiles/dotdirs from serving, so we need to explicitly include them by creating <code>_config.yml</code> at the top level of the Github repository having the following content</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;.well-known&quot;</span><span class="kw">]</span></span></code></pre></div></li>
</ul>
<h2 id="riotweb">Riot/Web</h2>
<p><code>riot-web</code> is a package already available within Nix packages which will take care of getting the right release package along with signature verification. So we can safely add the same to <code>systemPackages</code> like this</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">environment</span> = {</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">systemPackages</span> = with pkgs<span class="kw">;</span> <span class="bu">[</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>        riot-web</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">]</span><span class="kw">;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p>However, we need to let know Nix of the additional configuration required once riot-web is setup. That we could do via <em>overlays</em>. This is another advantage of declarative package management where we state in clear terms the state of our system which also help us revert in case unexpected happens.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">nixpkgs.overlays</span> = [</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">(</span><span class="ex">self:</span> super: {</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="ex">riot-web</span> = super.riot-web.override {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>            <span class="ex">conf</span> = {</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">default_server_config</span> = {</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;m.homeserver&quot;</span> = {</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;base_url&quot;</span> = <span class="st">&quot;https://matrix.dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;server_name&quot;</span> = <span class="st">&quot;dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                    <span class="er">}</span><span class="kw">;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;m.identity_server&quot;</span> = {</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;base_url&quot;</span> = <span class="st">&quot;https://vector.im&quot;</span><span class="kw">;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>                    <span class="er">}</span><span class="kw">;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>                 <span class="er">}</span><span class="kw">;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>                 <span class="co">## jitsi will be setup later,</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>                 <span class="co">## but we need to add to Riot configuration</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>                 <span class="ex">jitsi.preferredDomain</span> = <span class="st">&quot;jitsi.dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>            <span class="er">}</span><span class="kw">;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        <span class="er">}</span><span class="kw">;</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="er">}</span><span class="kw">)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>  <span class="ex">]</span><span class="kw">;</span></span></code></pre></div>
<h2 id="jitsi">Jitsi</h2>
<p>Finally we head towards our last leg of configurations - setting up <code>jitsi-meet</code>. Unfortunately, current master and stable channels of Nix packages lack <code>jitsi-meet</code> and other supporting packages required to setup Jitsi. However, it will change pretty soon thanks to the awesome work from user <a href="https://github.com/mmilata">mmilata</a> in this <a href="https://github.com/NixOS/nixpkgs/pull/82920">pull request</a>. It’s feature complete and might come as part of the next Nix release (20.03). However, we can already use the same via <a href="https://github.com/nix-community/NUR">NUR</a>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">imports</span> =</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">let</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>      <span class="ex">nur-no-pkgs</span> =</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="ex">import</span> <span class="er">(</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>          <span class="ex">builtins.fetchTarball</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>          <span class="st">&quot;https://github.com/nix-community/NUR/archive/master.tar.gz&quot;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">)</span> <span class="ex">{}</span><span class="kw">;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="er">in</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>      <span class="bu">[</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        nur-no-pkgs.repos.mmilata.modules.jitsi-meet</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">]</span><span class="kw">;</span></span></code></pre></div>
<p>The above import add only the new service to setup <code>jitsi-meet</code> without any other OS specific stuff. And the configuration for the new service would auto-magically setup the related software (like <code>videobridge</code> &amp; <code>jicofo</code>) to have a functioning Jitsi. We can then add a new virtual host to the Nginx configuration with the Jitsi <code>hostName</code> mentioned below (shown above in Nginx Section)</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">services.jitsi-meet</span> = {</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">hostName</span> = <span class="st">&quot;jitsi.dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">## this setting is going to add relevant ports to</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">## networking.firewall.allowedTCPPorts &amp;</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">## networking.firewall.allowedUDPPorts</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">videobridge.openFirewall</span> = true<span class="kw">;</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<h2 id="turn-server">TURN server</h2>
<p><code>jitsi-meet</code> Debian package takes care of setting up TURN server but in our case we need to take care of it ourselves. I followed the instructions mentioned in <a href="https://github.com/matrix-org/synapse/blob/master/docs/turn-howto.md">this documentation</a>. Nix already has a service configuration to setup <code>coturn</code>. Once set up, we will integrate the relevant parts to Synapse (which we have already done above).</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a> <span class="co"># /etc/nixos/configuration.nix</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="ex">services.coturn</span> = {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">enable</span> = true<span class="kw">;</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">use-auth-secret</span> = true<span class="kw">;</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">static-auth-secret</span> = <span class="st">&quot;XJmzTf6VixzX5pDZKHOxtiUenkKzr10tlhBWYoti5DvCxR4TM9XlRHxII3Ml6yV2&quot;</span><span class="kw">;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">realm</span> = <span class="st">&quot;turn.dangerousdemos.net&quot;</span><span class="kw">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">no-tcp-relay</span> = true<span class="kw">;</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">no-tls</span> = true<span class="kw">;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">no-dtls</span> = true<span class="kw">;</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">extraConfig</span> = <span class="st">''</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="ex">user-quota=12</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="ex">total-quota=1200</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">denied-peer-ip=10.0.0.0-10.255.255.255</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="ex">denied-peer-ip=192.168.0.0-192.168.255.255</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="ex">denied-peer-ip=172.16.0.0-172.31.255.255</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="ex">allowed-peer-ip=192.168.191.127</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">''</span><span class="kw">;</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>  <span class="er">}</span><span class="kw">;</span></span></code></pre></div>
<p><code>static-auth-secret</code> generated above is via the tool <code>pwgen</code> which in Nix we could do like this</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> nix-shell <span class="at">-p</span> pwgen <span class="at">--command</span> <span class="st">&quot;pwgen -s 64 1&quot;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">XJmzTf6VixzX5pDZKHOxtiUenkKzr10tlhBWYoti5DvCxR4TM9XlRHxII3Ml6yV2</span></span></code></pre></div>
<h2 id="conclusion">Conclusion</h2>
<p>Once we have <a href="https://gist.github.com/kaychaks/c1a79aef68c32818dec7540412c9ee4b">all the above configuration in place</a>, now is the time to finally run them all. This will take time to get all the necessary stuff downloaded and setup.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo nixos-rebuild switch</span></code></pre></div>
<p>However, once its done you can launch Riot/Web, register a new user, create a room with someone else from the same MatrixVerse, have end-to-end encrypted conversation, and also start having a video call via Jitsi. All that infrastructure now being 100% owned by you with a protocol enforcing privacy and decentralisation. And finally every piece here is fully open-source.</p>
<p>In these times of covert and overt surveillance its imperative to take matters at your hand. And when right tools make it simple to set them up and easy to reason their behavior, it’s a nice feeling.</p>
</div>

</article>

        </main>

        <footer class="page-width">
            <hr />
            <nav>
                <div class="menu-footer-menu-container">
                    <ul class="menu">
                        <li class="menu-item">
                            © 2020 <a target="_blank" href="https://keybase.io/kaushikc">Kaushik Chakraborty</a>
                        </li>

                        <li class="menu-item">
                            <a href="../archive.html"><strong>Archive</strong></a>
                        </li>

                        <li class="menu-item">
                            Styles influenced from <a href="https://webkit.org/blog/" target="_blank">WebKit Blog</a>
                        </li>
                        <li class="menu-item">
                            Generated via <a href="http://jaspervdj.be/hakyll" target="_blank">Hakyll</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </footer>
    </body>
</html>
